{% extends "layout.html" %}
{% block title %}Tasks | EMS Home{% endblock %}
{% block content %}
<h2>Tasks</h2>
{% include "databases/_saved_view.html" %}
<div class="card">
    <form method="get" class="filters">
        <div><label>Search<input type="text" name="q" value="{{ query.q }}"></label></div>
        <div><label>Status<select name="status"><option value="">Any</option>{% for s in statuses %}<option value="{{ s }}" {% if query.status==s %}selected{% endif %}>{{ s }}</option>{% endfor %}</select></label></div>
        <div><label>Project<select name="project_id"><option value="">Any</option>{% for p in projects %}<option value="{{ p.id }}" {% if query.project_id==(p.id|string) %}selected{% endif %}>{{ p.name }}</option>{% endfor %}</select></label></div>
        <div><label>Sort<select name="sort"><option value="updated_at">Updated</option><option value="title" {% if query.sort=='title' %}selected{% endif %}>Title</option><option value="status" {% if query.sort=='status' %}selected{% endif %}>Status</option></select></label></div>
        <div><label>Direction<select name="direction"><option value="desc">Desc</option><option value="asc" {% if query.direction=='asc' %}selected{% endif %}>Asc</option></select></label></div>
        <div><label><input type="checkbox" name="include_archived" value="1" {% if query.include_archived=='1' %}checked{% endif %}> Include archived</label></div>
        <button type="submit">Apply</button>
    </form>
    {% if current_user.role != 'Viewer' %}<a class="button-link" href="{{ url_for('databases.task_create') }}">New Task</a>{% endif %}
    <table>
        <tr><th>Title</th><th>Status</th><th>Project</th><th>Updated</th></tr>
        {% for task in tasks %}
            <tr class="clickable" onclick="window.location='{{ url_for('databases.task_detail', task_id=task.id) }}'">
                <td>{{ task.title }}</td><td>{{ task.status }}</td><td>{{ task.project.name if task.project else '-' }}</td><td>{{ task.updated_at }}</td>
            </tr>
        {% else %}<tr><td colspan="4">No tasks found.</td></tr>{% endfor %}
    </table>
</div>
{% endblock %}
